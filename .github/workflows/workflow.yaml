name: test

on:
  push:
    branches:
      - main
  # Trigger on pull requests targeting the main branch
  pull_request:
    branches:
      - main

jobs:
  test:
    name: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          # Enable caching for Go modules
          cache: true

      # Verify dependencies and ensure go.mod/go.sum are tidy
      # Run this *before* testing
      - name: Verify dependencies
        run: go mod tidy

      # Optional but recommended: Check if go mod tidy changed files
      # This ensures developers commit the tidy go.mod/go.sum files
      - name: Check for modified go.mod/go.sum
        run: |
          git diff --exit-code -- go.mod go.sum || \
          (echo "::error::go.mod or go.sum needs tidying (run 'go mod tidy' locally and commit changes)" && exit 1)

      # Run tests after verifying dependencies
      - name: Run Go Tests
        id: go_test # Keep the id if needed elsewhere
        run: go test -v ./...

      # Conditional step: Create a new tag if tests pass ON A PUSH to the main branch
      # We only want to tag on actual merges/pushes to main, not on PR builds.
      - name: Tag version
        # Check for success, ensure it's the main branch, AND ensure it was a push event (not pull_request)
        if: success() && github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2 # Use latest version (v6.2 as of writing)
        with:
          github_token: ${{ secrets.OG_RELEASE_TAG_UPDATE }}
          # The action defaults to tagging commits on the default branch (usually main)
          tag_prefix: v # Prefix for the tag (e.g., v1.2.3)
          # Consider adding custom_tag for more control if needed
